#!/bin/sh

# 判断是否是安全连接
if [ "${PROXY_SCHEME}" == "https" ] || [ "${PROXY_SCHEME}" == "HTTPS" ] || [ "${PROXY_SCHEME}" == "Https" ]; then
  export secure="true"
else
  export secure="false"
fi

CATALINA_OPTS="${CATALINA_OPTS} -Dproxy.name=${PROXY_DOMAIN} -Dproxy.port=${PROXY_PORT} -Dproxy.secure=${secure} -Dproxy.scheme=${PROXY_SCHEME} -Dcontext.path=${CONTEXT_PATH}"


# 将默认的数据库配置文件移动到主目录，原因是MySQL8有一个SSL连接的Bug，如果不使用MySQL8可以手动删除dbconfig.xml文件
dbConfigFile=${JIRA_HOME}/dbconfig.xml
if [ ! -f "${dbConfigFile}" ]; then
  gosu "${USERNAME}" cp /opt/atlassian/jira/dbconfig.xml "${dbConfigFile}"
fi


# 将主目录所有者改成系统创建的用户
permissionFile=${JIRA_HOME}/.permission.lock
if [ "${SET_PERMISSIONS}" == true ] && [ ! -f "${permissionFile}" ]; then
  chown -R "${USERNAME}":"${USERNAME}" "${JIRA_HOME}"

  if [ ! -f "${permissionFile}" ]; then
    gosu "${USERNAME}" touch "${permissionFile}"
  fi
fi
